<!--for X.PagedList Start-->
@using X.PagedList;
@using X.PagedList.Mvc.Core;
@{
    var pagedList = (IPagedList)ViewBag.PageList;
}
<link href="~/lib/x.paged-list/PagedList.css" rel="stylesheet" type="text/css" />

<link href="~/css/popoStyle.css" rel="stylesheet" type="text/css" />
<script src="~/js/popoLib.js" type="text/javascript"></script>



<link href="~/lib/magicsearch/jquery.magicsearch.css" rel="stylesheet" type="text/css" />
<script src="~/lib/magicsearch/jquery-2.2.3.min.js" type="text/javascript"></script>
<script src="~/lib/magicsearch/jquery.magicsearch.js" type="text/javascript"></script>


<link rel="stylesheet" href="~/lib//jquery-ui-1.12.1/jquery-ui.css">
<script src="~/lib//jquery-ui-1.12.1/jquery-ui.js"></script>

<!--for X.PagedList Edn-->
@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>


<script>
    function getTodayDate() {
        var fullDate = new Date();
        var yyyy = fullDate.getFullYear();
        var MM = (fullDate.getMonth() + 1) >= 10 ? (fullDate.getMonth() + 1) : ("0" + (fullDate.getMonth() + 1));
        var dd = fullDate.getDate() < 10 ? ("0" + fullDate.getDate()) : fullDate.getDate();
        var today = yyyy + "-" + MM + "-" + dd;
        return today;
    }
    //開啟編輯畫面
    function showEdit(workId) {
        //alert(workId);
        $('#showLoadingForEdit').show();

        if (workId != "") {

            //===修改===先藏起來等載完資料再顯示
            $('#editUI').hide();
            CallServerFunction("mesWork/GetWorkData?workID=" + workId, null, loadEditDataComplete);
        }
        else {
            //===新增===清空TextBox

            var Today = new Date();
            //var todayStr = Today.getFullYear() + "-" + (Today.getMonth() + 1) + "-" + Today.getDate();
            //var todayStr = $.datepicker.formatDate('dd M yy', new Date());
            var todayStr = getTodayDate();
            $('#txtIssueDate').val(todayStr);

            $('#txtWorkID').val('');
            $('#txtWorkName').val('');
            $('#txtWorkName').val('');
            $('#txtSRNo').val('');
            $('#txtSRTitle').val('');
            //顯示
            $('#showLoadingForEdit').hide();
            $('#editUI').show();
        }

        $('#editPanel').modal('show');
    }

    function loadEditDataComplete(jsonStr) {
        //alert(workData);
        //alert(workData.WorkName);   //注意大小寫有差

        var workData = JSON.parse(jsonStr);
        //注意!! workData 物件成員的大小寫要跟C#物件相符!!
        $('#txtWorkID').val(workData.WorkID);
        $('#txtWorkName').val(workData.WorkName);
        $('#txtDueDate').val(workData.DateDue);

        //alert(workData.OwnerIT);
        //$('#txtOwnerID').trigger('set', { id: '3,4' });

        for (var i = 0; i < dataSource.length; i++) {
            if (dataSource[i].id == "C2043") {
                $("#txtOwnerID").val(dataSource[i].id + ' ' + dataSource[i].notesID);
                break;
            }
        }

        $('#showLoadingForEdit').hide();
        $('#editUI').show();

        //$('#txtOwnerID').trigger('set', { id: '3' }); 無效
    }


</script>



<!-- Create Buttom -->
<input type="button" class="btn btn-primary" value="Create" onclick="showEdit(''); " />

<!-- Grid Table Start -->
<table class="table1">
    <tr>
        <th>SR No</th>
        <th>Title</th>
        <th>Detail</th>
        <th>IT</th>
        <th>Due</th>
        <th>Status</th>
        <th>Modify</th>
        <th>ID</th>
    </tr>

    @foreach (MESWork item in ViewBag.PageList)
    {
        <tr>

            <td>@Html.DisplayFor(modelItem2 => item.SRNo)</td>
            <td>@Html.DisplayFor(modelItem2 => item.WorkName)</td>
            <td>@Html.DisplayFor(modelItem2 => item.WorkDetail)</td>
            <td>@Html.DisplayFor(modelItem2 => item.OwnerIT)</td>
            <td>@Html.DisplayFor(modelItem2 => item.DateDue)</td>
            <td>@Html.DisplayFor(modelItem2 => item.Status)</td>
            <td><input type="button" class="btn btn-primary" style="font-size: x-small; padding-top: 1px; padding-bottom: 1px;" value="Modify" onclick="showEdit('@item.WorkID'); " /></td>
            <td>@Html.DisplayFor(modelItem2 => item.WorkID)</td>
        </tr>
    }

</table>
<!-- Grid Table End -->
<!--for X.PagedList Start-->
@Html.PagedListPager(pagedList, page => Url.Action("Index", new { page }), X.PagedList.Web.Common.PagedListRenderOptions.Classic)
<!--for X.PagedList End-->

<input type="file" class="multi" accept="gif|jpg" />
<input type="file" multiple
       class="multi maxsize-15120 with-preview" accept="xlsx" />


<!-- 編輯畫面 Start -->
<div id="editPanel" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg" style="min-width: 90vw !important;">
        <div class="modal-content" style="padding:30px; background-color:#223344; color:#99DDFF; font-size:small;">

            <div id="showLoadingForEdit">Loading...</div>
            <!-- onkeypress="return event.keyCode != 13;" 這行的目的是不要讓 Enter 鍵觸發 Submit  -->
            <form method="post" action="mesWork/Edit">
                @Html.AntiForgeryToken()
                <table id="editUI">
                    <tr onkeypress="return event.keyCode != 13;">
                        <th style="padding:5px;">WorkID</th>
                        <td>
                            <table style="padding:0;margin:0;">
                                <tr>
                                    <td><input type="text" value="" style="width:200px; height:25px !important;" id="txtWorkID" name="txtWorkID" readonly /></td>
                                    <th style="white-space: nowrap; padding-left: 10px;">Issue</th>
                                    <td><input type="text" value="" style="width:80px; height: 25px !important;" id="txtIssueDate" name="txtIssueDate" /></td>
                                </tr>
                            </table>

                        </td>
                    </tr>
                    <tr onkeypress="return event.keyCode != 13;">
                        <th style="padding:5px;">Owner</th>
                        <td>
                            <input type="text" class="magicsearch" style="width:200px !important; height:25px !important;" id="txtITOwner" name="txtITOwner" placeholder="IT Owner">

                        </td>
                    </tr>
                    <tr onkeypress="return event.keyCode != 13;">
                        <th style="padding:5px;">User1</th>
                        <td>
                            <table style="padding:0;margin:0;">
                                <tr>
                                    <td><input type="text" style="width:70px !important; height:25px !important;" id="txtUser1" name="txtUser1" placeholder="窗口"></td>
                                    <td><div id="lblUserName1" style="color:#778899;font-size:x-small;padding-left:5px;"></div></td>
                                    <th style="white-space: nowrap; padding-left: 10px;">User2</th>
                                    <td><input type="text" style="width:70px !important; height:25px !important;" id="txtUser2" name="txtUser2" placeholder="需求者"></td>
                                    <td><div id="lblUserName2" style="color:#778899;font-size:x-small;padding-left:5px;"></div></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr onkeypress="return event.keyCode != 13;">
                        <th style="padding:5px;">WorkName</th>
                        <td><input type="text" value="" style="width:600px; height:25px !important;" id="txtWorkName" name="txtWorkName" /></td>
                    </tr>
                    <tr>
                        <th style="padding:5px;">WorkDetail</th>
                        <td style="padding-top:5px;"><textarea id="txtWorkDetail" name="txtWorkDetail" cols="100" rows="6"></textarea></td>
                    </tr>
                    <tr onkeypress="return event.keyCode != 13;">
                        <th style="padding:5px;">Type1</th>
                        <td>
                            <table style="padding:0;margin:0;">
                                <tr>
                                    <td>
                                        <select id="ddlType1" name="ddlType1">
                                            <option>議題討論</option>
                                            <option>程式修改</option>
                                            <option>資料設定</option>
                                            <option>資料修改</option>
                                            <option>資料提供</option>
                                            <option>盤點工作</option>
                                            <option>專案任務</option>
                                            <option>課程參加</option>
                                            <option>異常排除</option>
                                            <option>其他</option>
                                            <option>指導協助</option>
                                            <option>支援工作</option>
                                            <option>特殊業務</option>
                                            <option>系統專家</option>
                                        </select>
                                    </td>
                                    <th style="white-space: nowrap; padding-left: 10px;">Type2</th>
                                    <td><input type="text" value="" style="width:100px; height: 25px !important;" id="txtType2" name="txtType2" placeholder="PE,EE..." /></td>
                                    <th style="white-space: nowrap; padding-left:10px;">Type3</th>
                                    <td><input type="text" value="" style="width:120px; height: 25px !important;" id="txtType3" name="txtType3" placeholder="RMS,Marking..." /></td>
                                    <th style="white-space: nowrap; padding-left:10px;">重要性</th>
                                    <td>
                                        <select id="ddlWeight" name="ddlWeight">
                                            <option>1</option>
                                            <option>3</option>
                                            <option>5</option>
                                            <option>10</option>
                                        </select>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr onkeypress="return event.keyCode != 13;">
                        <th style="padding:5px;">狀態</th>
                        <td>
                            <table style="padding:0;margin:0;">
                                <tr>
                                    <td>
                                        <select id="ddlStatus" name="ddlStatus">
                                            <option>Survey</option>
                                            <option>Wait-Assign</option>
                                            <option>OnGoing</option>
                                            <option>Testing</option>
                                            <option>Trail-Run</option>
                                            <option>Closed</option>
                                            <option>Pending</option>
                                        </select>
                                    </td>
                                    <td><span style="color:#777777;font-size:xx-small;">Survey：不確定要做。WaitAssign：確認待派工。Pending：狀況不明。</span></td>
                                </tr>
                            </table>
                            
                        </td>
                    </tr>
                    <tr onkeypress="return event.keyCode != 13;">
                        <th style="padding:5px;">Due Date</th>
                        <td>
                            <table style="padding:0;margin:0;">
                                <tr>
                                    <td><input type="text" value="" style="width:80px; height:25px !important;" id="txtDueDate" name="txtDueDate" /></td>
                                    <th style="white-space: nowrap; padding-left: 10px;">開始</th>
                                    <td><input type="text" value="" style="width:80px; height: 25px !important;" id="txtStartDate" name="txtStartDate" /></td>
                                    <th style="white-space: nowrap; padding-left:10px;">完成</th>
                                    <td><input type="text" value="" style="width:80px; height: 25px !important;" id="txtEndDate" name="txtEndDate" /></td>
                                    <th style="white-space: nowrap; padding-left: 10px;">結案</th>
                                    <td><input type="text" value="" style="width:80px; height: 25px !important;" id="txtCloseDate" name="txtCloseDate" /></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr onkeypress="return event.keyCode != 13;">
                        <th style="padding:5px;">SR No</th>
                        <td><input type="text" value="" style="height:25px !important;" id="txtSRNo" name="txtSRNo" /></td>
                    </tr>
                    <tr onkeypress="return event.keyCode != 13;">
                        <th style="padding:5px;">SR Title</th>
                        <td><input type="text" value="" style="width: 600px; height: 25px !important;" id="txtSRTitle" name="txtSRTitle" /></td>
                    </tr>
                    <tr>
                        <th style="padding:5px;">Benfit</th>
                        <td style="padding-top:5px;"><textarea id="txtBenfit" name="txtBenfit" cols="100" rows="5" style="white-space: normal !important; "></textarea></td>
                    </tr>
                    <tr onkeypress="return event.keyCode != 13;">
                        <th style="padding:5px;">客戶</th>
                        <td>
                            <table style="padding:0;margin:0;">
                                <tr>
                                    <td><input type="text" value="" style="width:90px; height:25px !important;" id="txtOper" name="txtOper" /></td>
                                    <th style="white-space: nowrap; padding-left: 10px;">站點</th>
                                    <td><input type="text" value="" style="width:90px; height: 25px !important;" id="txtCust3" name="txtCust3" /></td>
                                    <th style="white-space: nowrap; padding-left:10px;">廠別</th>
                                    <td><input type="text" value="" style="width:90px; height: 25px !important;" id="txtFac" name="txtFac" /></td>
                                </tr>
                            </table>
                        </td>
                    </tr>


                    <tr>
                        <td></td>
                        <td style="padding-top:10px;">
                            <input type="submit" value="Save" class="btn btn-success" /> &nbsp; 
                            <input type="button" value="Cancel" class="btn btn-warning" onclick="$('#editPanel').modal('hide');" />
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
</div>


<!-- 編輯畫面 End -->
<!-- AutoComplete -->
<style>
    /*AutoComplete 必加不然看不到下拉項目*/
    .ui-autocomplete {
        z-index: 9999 !important;
    }
</style>
<script>
    $("#txtUser1").autocomplete({
        source: function (request, response) {
            jQuery.get("mesWork/GetMatchUser", {
                query: request.term
            }, function (data) {
                var data2 = JSON.parse(data);
                response(data2);
            });
        },
        select: function (event, ui) {
            //event引數是事件物件，ui物件只有一個item屬性，對應資料來源中被選中的物件
            $("#lblUserName1").text(ui.item.label);
            $("#txtUser1").val(ui.item.value);
            return false;
        },
        //change: function (e, ui) {
        //    $("#lblUserName1").text(ui.item.label);
        //    $("#txtUser1").val(ui.item.value);
        //}, 
        minLength: 2
    });
    $("#txtUser2").autocomplete({
        source: function (request, response) {
            jQuery.get("mesWork/GetMatchUser", {
                query: request.term
            }, function (data) {

                //response(workData);
                //alert(data);
                var data2 = JSON.parse(data);
                //alert(data2);
                response(data2);
                //response($.map(data2, function (item) { // 此處是將返回資料轉換為 JSON物件
                //    //alert(item.label);
                //    return {
                //        label: item.label, // 下拉項顯示內容
                //        value: item.value  // 下拉項對應數值
                //        //另外可以自定義其它引數
                //    }
                //}));
            });
        },
        select: function (event, ui) {
            //event引數是事件物件，ui物件只有一個item屬性，對應資料來源中被選中的物件
            $("#lblUserName2").text(ui.item.label);
            $("#txtUser2").val(ui.item.value);
            return false;
        },
        minLength: 2
    });
</script>

<!-- magicsearch -->
<script>
    $.datepicker.setDefaults($.datepicker.regional[""]);
    $("#txtDueDate").datepicker({ dateFormat: 'yy-mm-dd' });
    $("#txtStartDate").datepicker({ dateFormat: 'yy-mm-dd' });
    $("#txtEndDate").datepicker({ dateFormat: 'yy-mm-dd' });
    $("#txtIssueDate").datepicker({ dateFormat: 'yy-mm-dd' });
    $("#txtCloseDate").datepicker({ dateFormat: 'yy-mm-dd' });
</script>
<!-- magicsearch -->
<script>


    var dataSource = [
        { id: 'C2043', notesID: 'Potato', cName: '黃群凱' },
        { id: '2', notesID: 'Eric', cName: 'Baker' },
        { id: '3', notesID: 'Victor', cName: 'Brown' },
        { id: '4', notesID: 'Lisa', cName: 'White' },
        { id: '5', notesID: 'Oliver', cName: 'Bull' },
        { id: '6', notesID: 'Zade', cName: 'Stock' },
        { id: '7', notesID: 'David', cName: 'Reed' },
        { id: '8', notesID: 'George', cName: 'Hand' },
        { id: '9', notesID: 'Tony', cName: 'Well' },
        { id: '10', notesID: 'Bruce', cName: 'Wayne' },
    ];
    $('#txtITOwner').magicsearch({
        dataSource: dataSource,
        fields: ['id', 'notesID', 'cName'],
        id: 'id',
        format: ' %notesID% %cName% %id% ',
        dropdownBtn: true,
        focusShow: true
    });

    $('#set-btn').click(function () {
        //alert('ss');
        //.val("val2").change();
        //$("#txtOwnerID").val('C2043').trigger("liszt:updated");

        for (var i = 0; i < dataSource.length; i++) {
            if (dataSource[i].id == "C2043") {
                $("#txtOwnerID").val(dataSource[i].id + ' ' + dataSource[i].notesID);
                break;
            }
        }

        //$("#txtOwnerID option[value='C2043']").prop('selected', true);
        //$("#txtOwnerID").val('C2043').change();
        //$('#txtOwnerID').trigger('set', { id: '3' });
        //alert($("#txtOwnerID").val());
        //$("#txtOwnerID option").each(function () {
        //    alert($(this).text());
        //    if ("C2043" === $(this).text()) {
        //        value = $(this).val();
        //    }
        //});
    });
</script>





